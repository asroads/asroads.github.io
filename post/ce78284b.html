<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Regular.woff2" as="font">
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Bold.woff2" as="font">
    
    
    
        <link rel="shortcut icon" href="/icons/favicon.ico">
    

    
    
        
<link rel="stylesheet" href="/css/mdui.min.v1.0.0.css">

    
    
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/iconfont.css">


    
    












          


    
    
    <title>
        
            地图缩放拖动组件｜Cocos Creator 3.0 | Asroads&#39;Blog
        
    </title>
    
    
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Asroads'Blog" type="application/atom+xml">
</head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-teal mdui-theme-accent-blue">
  
  <header class="mdui-appbar mdui-appbar-fixed">
  <div id="toolbar" class="mdui-toolbar mdui-color-theme">
    <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="iconfont icon-menu"></i></button>
    <a href="/" class="mdui-typo-headline">Asroads&#39;Blog</a>
    <a href="/" class="header-subtitle mdui-typo-headline">君子不器</a>
    <div class="mdui-toolbar-spacer"></div>
    <button class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: 'search'}"><i class="iconfont icon-search"></i></button>
  </div>
</header>

<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字" onfocus="listenSearchFunc()">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>

  <aside id="sidebar" class="mdui-drawer">
    <div class="mdui-tab" mdui-tab>
        <a href="#sidebar-tab1" id="sidebartab" class="mdui-ripple mdui-tab-active">站点概览</a>
        <a href="#sidebar-tab2" id="sidebartab" class="mdui-ripple">关于</a>
    </div>

    
    <div id="sidebar-tab1" class="mdui-p-a-1">
        <div class="mdui-list">
            
                
                <a href="/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-home"></i>
                    </div>
                    <div class="mdui-list-item-content">首页</div>
                </a>
            
                
                <a href="/categories/game" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-folder"></i>
                    </div>
                    <div class="mdui-list-item-content">手游</div>
                </a>
            
                
                <a href="/categories/tool/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-tools"></i>
                    </div>
                    <div class="mdui-list-item-content">技术</div>
                </a>
            
                
                <a href="/categories/other" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-gallery"></i>
                    </div>
                    <div class="mdui-list-item-content">杂项</div>
                </a>
            
                
                <a href="/categories/life" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-blog"></i>
                    </div>
                    <div class="mdui-list-item-content">感悟</div>
                </a>
            
                
                <a href="/tags/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-bookmark"></i>
                    </div>
                    <div class="mdui-list-item-content">标签</div>
                </a>
            
                
                <a href="/archives/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-archive"></i>
                    </div>
                    <div class="mdui-list-item-content">归档</div>
                </a>
            
                
                <a href="/about/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-user"></i>
                    </div>
                    <div class="mdui-list-item-content">关于</div>
                </a>
            
            <div class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-icon">
                    <i class="iconfont icon-moon"></i>
                </div>
                <div class="mdui-list-item-content">夜间模式</div>
                <label class="mdui-switch" id="darkmode">
                  <input type="checkbox" id="nightmode_switch"/>
                  <i class="mdui-switch-icon"></i>
                </label>
            </div>           
        </div>
    </div>

    
    <div id="sidebar-tab2" class="mdui-p-a-1">
        <div class="sidebar-overview">
            <div class="sidebar-avatar">
                
                    <img src="/icons/avatar.png"/>
                
            </div>
            <div class="sidebar-author-name">asroads</div>
            <div class="sidebar-description">自信是成功第一法宝</div>
        </div>
        <div class="sidebar-links">
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-mail"></i></span>
                    <a href="/jsroads@163.com" class="mdui-chip-title">E-Mail</a>
                </div>
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-github"></i></span>
                    <a target="_blank" rel="noopener" href="https://github.com/jsroads" class="mdui-chip-title">jsroads</a>
                </div>
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-github"></i></span>
                    <a target="_blank" rel="noopener" href="https://github.com/asroads" class="mdui-chip-title">asroads</a>
                </div>
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-qq"></i></span>
                    <a target="_blank" rel="noopener" href="https://jq.qq.com/?_wv=1027&k=fTVxmSSA" class="mdui-chip-title">QQ群</a>
                </div>
            
        </div>
        <ul class="mdui-list" mdui-collapse="{accordion: true}">
            <li class="mdui-collapse-item">
                <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-link"></i>
                    </div>
                    <div class="mdui-list-item-content">友情链接</div>
                    <div class="mdui-collapse-item-arrow">
                        <i class="mdui-list-item-icon iconfont icon-angle-down"></i>
                    </div>
                </div>
                <ul id="linksList" class="mdui-collapse-item-body mdui-list mdui-list-dense">
                    
                        <a target="_blank" rel="noopener" href="https://seazhang.github.io/" class="mdui-list-item mdui-ripple">
                            麦田守望者
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://zhaoyabo.github.io/" class="mdui-list-item mdui-ripple">
                            YABO的博客
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://dreamheavenyang.github.io/" class="mdui-list-item mdui-ripple">
                            DreamHeaven
                        </a>
                    
                </ul>
            </li>
        </ul>
    </div>

    <div class="mdui-divider"></div>
    
    
</aside>
  
  <main id="main-contain" class="mdui-container mdui-m-t-5">
    <article id="article" class="mdui-card mdui-p-b-2 mdui-m-b-5">
  <header class="mdui-card-media">
    
    
      <div class="post-header"> 
  <a class="post-header-title" href="/post/ce78284b.html">地图缩放拖动组件｜Cocos Creator 3.0</a>
  <div class="post-header-meta">
    <span>
      <span class="iconfont icon-calendar"></span>
      发布于:&nbsp;2021-04-19
    </span>
    <span>
      <span class="iconfont icon-calendar-check"></span>
      更新于:&nbsp;2025-04-22
    </span>
    <span>
      <span class="iconfont icon-folder"></span>
      分类于:&nbsp;<a class="category-link" href="/categories/game/">game</a>
    </span>
    
      <span>
        <span class="iconfont icon-eye"></span>
        阅读次数:&nbsp;
        <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
      </span>
    
  </div>
</div>   
    



    
    
    <div class="mdui-card-menu">
    
      <button class="mdui-btn mdui-btn-icon mdui-text-color-teal" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="iconfont icon-share"></i></button>
      <ul class="mdui-menu" id="share_menu">
        <li class="mdui-menu-item">
          <a href="http://service.weibo.com/share/share.php?appkey=&title=地图缩放拖动组件｜Cocos Creator 3.0&url=http://blog.asroads.com/post/ce78284b.html&pic=http://blog.asroads.com/icons/favicon.ico&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到 Weibo</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://twitter.com/intent/tweet?text=地图缩放拖动组件｜Cocos Creator 3.0&url=http://blog.asroads.com/post/ce78284b.html&via=asroads" target="_blank" class="mdui-ripple">分享到 Twitter</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.asroads.com/post/ce78284b.html" target="_blank" class="mdui-ripple">分享到 Facebook</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://plus.google.com/share?url=http://blog.asroads.com/post/ce78284b.html" target="_blank" class="mdui-ripple">分享到 Google+</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://blog.asroads.com/post/ce78284b.html&title=地图缩放拖动组件｜Cocos Creator 3.0" target="_blank" class="mdui-ripple">分享到 LinkedIn</a>
        </li>
        <li class="mdui-menu-item">
          <a href="http://connect.qq.com/widget/shareqq/index.html?site=Asroads&#39;Blog&title=地图缩放拖动组件｜Cocos Creator 3.0&summary=自信是成功第一法宝&pics=http://blog.asroads.com/icons/favicon.ico&url=http://blog.asroads.com/post/ce78284b.html" target="_blank" class="mdui-ripple">分享到 QQ</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://telegram.me/share/url?url=http://blog.asroads.com/post/ce78284b.html&text=地图缩放拖动组件｜Cocos Creator 3.0" target="_blank" class="mdui-ripple">分享到 Telegram</a>
        </li>
      </ul>
    
  </div>
  </header>
  
  
  
  
  <div class="post-tags">
    
      <i class="iconfont icon-tag">
        <a rel="tag" href = /tags/Cocos/ >Cocos</a>
      </i>
    
  </div>

  
  <div class="mdui-card-content mdui-typo mdui-p-x-4">
    <p>随着手游的兴起，越来越多的玩法涌现出来，地图拖动缩放组件在很多玩法中都有用到，这里给出一个Cocos Creator 3.6.2的组件</p>
<span id="more"></span>

<h2 id="无惯性简单版本"><a href="#无惯性简单版本" class="headerlink" title="无惯性简单版本"></a>无惯性简单版本</h2><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>先展示一下 效果：</p>
<p><img src="/post/ce78284b/mapdrag.gif" alt="mapdrag"></p>
<h3 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h3><p>主要是给Node节点添加事件，根据触摸或者滚轮的方向和速度来控制地图的缩放或者拖动。</p>
<h4 id="用到的事件类型"><a href="#用到的事件类型" class="headerlink" title="用到的事件类型"></a>用到的事件类型</h4><ul>
<li><strong>Node.EventType.MOUSE_WHEEL</strong>  Web 下鼠标滚轮滚动缩放地图</li>
<li><strong>Node.EventType.TOUCH_START</strong></li>
<li><strong>Node.EventType.TOUCH_MOVE</strong></li>
<li><strong>Node.EventType.TOUCH_END</strong></li>
<li><strong>Node.EventType.TOUCH_CANCEL</strong></li>
</ul>
<p>触摸事件（Event.EventTouch）的处理</p>
<h4 id="用到的API"><a href="#用到的API" class="headerlink" title="用到的API"></a>用到的API</h4><ul>
<li><strong>getLocation</strong> 获取鼠标位置对象，对象包含 x 和 y 属性。</li>
<li><strong>getUILocation</strong> 获取当前鼠标在 UI 窗口内相对于左下角的坐标位置，对象包含 x 和 y 属性。</li>
</ul>
<p>其他API 可以查看 <a target="_blank" rel="noopener" href="https://docs.cocos.com/creator/3.0/manual/zh/engine/event/event-api.html#%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6-API">全局与节点触摸和鼠标事件 API</a></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>项目结构截图—RootMapNode</p>
<p><img src="/post/ce78284b/image-20210419132030028.png" alt="image-20210419132030028"></p>
<p>MapNode</p>
<p><img src="/post/ce78284b/image-20210419132040677.png" alt="image-20210419132040677"></p>
<p>2.4.10 版本 核心代码：<code>MapTouchController.ts</code>  <a target="_blank" rel="noopener" href="https://github.com/jsroads/mylibs/tree/main/mapScaleDemo/2.4.10%20assets">源码查看</a></p>
<p>3.0 核心代码：<code>MapTouchController.ts</code>（待优化…）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    _decorator,</span><br><span class="line">    <span class="title class_">CCBoolean</span>,</span><br><span class="line">    <span class="title class_">CCFloat</span>,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    <span class="title class_">EventMouse</span>,</span><br><span class="line">    <span class="title class_">EventTouch</span>,</span><br><span class="line">    isValid,</span><br><span class="line">    <span class="title class_">Label</span>,</span><br><span class="line">    misc,</span><br><span class="line">    <span class="title class_">Node</span>,</span><br><span class="line">    <span class="title class_">Rect</span>,</span><br><span class="line">    rect,</span><br><span class="line">    <span class="title class_">Touch</span>,</span><br><span class="line">    <span class="title class_">UITransform</span>,</span><br><span class="line">    v2,</span><br><span class="line">    v3,</span><br><span class="line">    <span class="title class_">Vec2</span>,</span><br><span class="line">    <span class="title class_">Vec3</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;cc&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by jsroads on 2021/4/15.4:35 下午</span></span><br><span class="line"><span class="comment"> * Note:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> &#123;ccclass, property&#125; = _decorator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ccclass</span>(<span class="string">&#x27;MapTouchController&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MapTouchController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Node</span>,</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;目标节点&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">map</span>: <span class="title class_">Node</span> = <span class="literal">null</span>!;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(<span class="title class_">Label</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">scaleTime</span>: <span class="title class_">Label</span> = <span class="literal">null</span>!;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;图片初始缩放&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">defaultScaling</span>: <span class="built_in">number</span> = <span class="number">1.1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;图片缩放最小scale&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">minScale</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;图片缩放最大scale&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">maxScale</span>: <span class="built_in">number</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;单点触摸容忍误差&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">moveOffset</span>: <span class="built_in">number</span> = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;滚轮缩放比率&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">increaseRate</span>: <span class="built_in">number</span> = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">displayName</span>: <span class="string">&#x27;双指缩放速率&#x27;</span>,</span><br><span class="line">        <span class="attr">max</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0.001</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">fingerIncreaseRate</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="attr">locked</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>; <span class="comment">// 操作锁</span></span><br><span class="line">    <span class="keyword">public</span> <span class="attr">singleTouchCb</span>: <span class="title class_">Function</span> = <span class="literal">null</span>!; <span class="comment">// 点击回调函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">isMoving</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>; <span class="comment">// 是否拖动地图flag</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">mapTouchList</span>: <span class="built_in">any</span>[] = []; <span class="comment">// 触摸点列表容器</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(<span class="title class_">CCBoolean</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">isStrict</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>; <span class="comment">// 默认为非严格模式</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">onLoad</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addEvent</span>();</span><br><span class="line">        <span class="comment">// this.defaultScaling = 1</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">smoothOperate</span>(<span class="variable language_">this</span>.<span class="property">map</span>, <span class="title function_">v3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">defaultScaling</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">setPosition</span>(<span class="number">0</span>, <span class="number">225</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">canStartMove</span>(<span class="attr">touch</span>: <span class="title class_">Touch</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">        <span class="comment">// 有些设备单点过于灵敏，单点操作会触发TOUCH_MOVE回调，在这里作误差值判断</span></span><br><span class="line">        <span class="keyword">return</span> touch.<span class="title function_">getDelta</span>().<span class="title function_">length</span>() &gt; <span class="variable language_">this</span>.<span class="property">moveOffset</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">addEvent</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_MOVE</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">touches</span>: <span class="title class_">Touch</span>[] = event.<span class="title function_">getTouches</span>(); <span class="comment">// 获取所有触摸点</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isStrict</span>) &#123; <span class="comment">// 严格模式下过滤掉初始点击位置不在目标节点范围内的触摸点</span></span><br><span class="line">                touches</span><br><span class="line">                    .<span class="title function_">filter</span>(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">startPos</span>: <span class="title class_">Vec2</span> = <span class="title function_">v2</span>(v.<span class="title function_">getStartLocation</span>()); <span class="comment">// 触摸点最初的位置</span></span><br><span class="line">                        <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">worldRect</span>: <span class="title class_">Rect</span> = <span class="title function_">rect</span>(</span><br><span class="line">                            worldPos.<span class="property">x</span> - transform.<span class="property">width</span> / <span class="number">2</span>,</span><br><span class="line">                            worldPos.<span class="property">y</span> - transform.<span class="property">height</span> / <span class="number">2</span>,</span><br><span class="line">                            transform.<span class="property">width</span>,</span><br><span class="line">                            transform.<span class="property">height</span></span><br><span class="line">                        );</span><br><span class="line">                        <span class="keyword">return</span> worldRect.<span class="title function_">contains</span>(startPos);</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">forEach</span>(<span class="function"><span class="params">v</span> =&gt;</span> &#123; <span class="comment">// 将有效的触摸点放在容器里自行管理</span></span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">intersection</span>: <span class="built_in">any</span>[] = <span class="variable language_">this</span>.<span class="property">mapTouchList</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">v1</span> =&gt;</span> v1.<span class="property">id</span> === v.<span class="title function_">getID</span>());</span><br><span class="line">                        <span class="keyword">if</span> (intersection.<span class="property">length</span> === <span class="number">0</span>)</span><br><span class="line">                            <span class="variable language_">this</span>.<span class="property">mapTouchList</span>[<span class="variable language_">this</span>.<span class="property">mapTouchList</span>.<span class="property">length</span>] = (&#123;<span class="attr">id</span>: v.<span class="title function_">getID</span>(), <span class="attr">touch</span>: v&#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                touches = <span class="variable language_">this</span>.<span class="property">mapTouchList</span>.<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> v.<span class="property">touch</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (touches.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;multi touch&#x27;);</span></span><br><span class="line">                <span class="comment">// multi touch</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touch1</span>: <span class="title class_">Touch</span> = touches[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touch2</span>: <span class="title class_">Touch</span> = touches[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">delta1</span>: <span class="title class_">Vec2</span> = <span class="title function_">v2</span>(touch1.<span class="title function_">getDelta</span>());</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">delta2</span>: <span class="title class_">Vec2</span> = <span class="title function_">v2</span>(touch2.<span class="title function_">getDelta</span>());</span><br><span class="line">                <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touchPoint1</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(<span class="title function_">v3</span>(touch1.<span class="title function_">getUILocation</span>().<span class="property">x</span>, touch1.<span class="title function_">getUILocation</span>().<span class="property">y</span>));</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touchPoint2</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(<span class="title function_">v3</span>(touch2.<span class="title function_">getUILocation</span>().<span class="property">x</span>, touch2.<span class="title function_">getUILocation</span>().<span class="property">y</span>));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="attr">distance</span>: <span class="title class_">Vec3</span> = touchPoint1.<span class="title function_">subtract</span>(touchPoint2);</span><br><span class="line">                <span class="comment">// const rateV2: Vec2 = v2(this.fingerIncreaseRate, this.fingerIncreaseRate);</span></span><br><span class="line">                <span class="keyword">let</span> <span class="attr">delta</span>: <span class="title class_">Vec2</span> = delta1.<span class="title function_">subtract</span>(delta2).<span class="title function_">multiplyScalar</span>(<span class="variable language_">this</span>.<span class="property">fingerIncreaseRate</span>);</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">scale</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(distance.<span class="property">x</span>) &gt; <span class="title class_">Math</span>.<span class="title function_">abs</span>(distance.<span class="property">y</span>)) &#123;</span><br><span class="line">                    scale = (distance.<span class="property">x</span> + delta.<span class="property">x</span>) / distance.<span class="property">x</span> * <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getScale</span>().<span class="property">x</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    scale = (distance.<span class="property">y</span> + delta.<span class="property">y</span>) / distance.<span class="property">y</span> * <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getScale</span>().<span class="property">y</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">pos</span>: <span class="title class_">Vec3</span> = touchPoint2.<span class="title function_">add</span>(<span class="title function_">v3</span>(distance.<span class="property">x</span> / <span class="number">2</span>, distance.<span class="property">y</span> / <span class="number">2</span>));</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">smoothOperate</span>(<span class="variable language_">this</span>.<span class="property">map</span>, pos, scale);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (touches.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;single touch&#x27;);</span></span><br><span class="line">                <span class="comment">// single touch</span></span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touch</span>: <span class="title class_">Touch</span> = touches[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isMoving</span> || <span class="variable language_">this</span>.<span class="title function_">canStartMove</span>(touch)) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">const</span> <span class="attr">distance</span>:<span class="title class_">Vec3</span> = <span class="title function_">v3</span>(touch.<span class="title function_">getDelta</span>().<span class="property">x</span>, touch.<span class="title function_">getDelta</span>().<span class="property">y</span>,<span class="number">0</span>);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">dealMove</span>(distance, <span class="variable language_">this</span>.<span class="property">map</span>, <span class="variable language_">this</span>.<span class="property">node</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不能移动&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;未知触摸类型&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_START</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_END</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">touches</span>: <span class="built_in">any</span>[] = <span class="variable language_">this</span>.<span class="property">isStrict</span> ? <span class="variable language_">this</span>.<span class="property">mapTouchList</span> : event.<span class="title function_">getTouches</span>();</span><br><span class="line">            <span class="keyword">if</span> (touches.<span class="property">length</span> &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isMoving</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = <span class="title function_">v3</span>(event.<span class="title function_">getLocation</span>().<span class="property">x</span>, event.<span class="title function_">getLocation</span>().<span class="property">y</span>);</span><br><span class="line">                    <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">                    <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">dealSelect</span>(nodePos);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">false</span>; <span class="comment">// 当容器中仅剩最后一个触摸点时将移动flag还原</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isStrict</span>) <span class="variable language_">this</span>.<span class="title function_">removeTouchFromContent</span>(event, <span class="variable language_">this</span>.<span class="property">mapTouchList</span>);</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_CANCEL</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">touches</span>: <span class="built_in">any</span>[] = <span class="variable language_">this</span>.<span class="property">isStrict</span> ? <span class="variable language_">this</span>.<span class="property">mapTouchList</span> : event.<span class="title function_">getTouches</span>();</span><br><span class="line">            <span class="comment">// 当容器中仅剩最后一个触摸点时将移动flag还原</span></span><br><span class="line">            <span class="keyword">if</span> (touches.<span class="property">length</span> &lt;= <span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isStrict</span>)</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">removeTouchFromContent</span>(event, <span class="variable language_">this</span>.<span class="property">mapTouchList</span>);</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">MOUSE_WHEEL</span>, <span class="function">(<span class="params">event: EventMouse</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">scrollDelta</span>: <span class="built_in">number</span> = event.<span class="title function_">getScrollY</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">scale</span>: <span class="built_in">number</span> = (<span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getScale</span>().<span class="property">x</span> + (scrollDelta / <span class="variable language_">this</span>.<span class="property">increaseRate</span>));</span><br><span class="line">            <span class="comment">// scale = this.map.getScale().x+0.2</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">target</span>: <span class="title class_">Node</span> = <span class="variable language_">this</span>.<span class="property">map</span>;</span><br><span class="line">            <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">pos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(<span class="title function_">v3</span>(event.<span class="title function_">getUILocation</span>().<span class="property">x</span>, event.<span class="title function_">getUILocation</span>().<span class="property">y</span>));</span><br><span class="line">            <span class="comment">// pos = v3(50,50)</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">smoothOperate</span>(target, pos, scale);</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">removeTouchFromContent</span>(<span class="attr">event</span>: <span class="title class_">EventTouch</span>, <span class="attr">content</span>: <span class="built_in">any</span>[]): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">eventToucheIDs</span>: <span class="built_in">number</span>[] = event[<span class="string">&#x27;getTouches&#x27;</span>]().<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> v.<span class="title function_">getID</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> len = content.<span class="property">length</span>, i = len - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (eventToucheIDs.<span class="title function_">indexOf</span>(content[i].<span class="property">id</span>) &gt; -<span class="number">1</span>)</span><br><span class="line">                content.<span class="title function_">splice</span>(i, <span class="number">1</span>); <span class="comment">// 删除触摸</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">smoothOperate</span>(<span class="attr">target</span>: <span class="title class_">Node</span>, <span class="attr">pos</span>: <span class="title class_">Vec3</span>, <span class="attr">scale</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="comment">// 放大缩小</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">minScale</span> &lt;= scale &amp;&amp; scale &lt;= <span class="variable language_">this</span>.<span class="property">maxScale</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取速率的小数后几位，防止速率过小时取整直接舍弃掉了变化</span></span><br><span class="line">            scale = <span class="title class_">Number</span>(scale.<span class="title function_">toFixed</span>(<span class="number">2</span>));</span><br><span class="line">            <span class="comment">// let deltaScale: number = scale - target.getScale().x;</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">uiScaleVec3</span>: <span class="title class_">Vec3</span> = <span class="title function_">v3</span>(target.<span class="title function_">getScale</span>().<span class="property">x</span>, target.<span class="title function_">getScale</span>().<span class="property">y</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">uiTouchPos</span>: <span class="title class_">Vec3</span> = (pos.<span class="title function_">clone</span>().<span class="title function_">subtract</span>(target.<span class="property">position</span>.<span class="title function_">clone</span>())).<span class="title function_">divide</span>(uiScaleVec3);</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">mapPos</span>: <span class="title class_">Vec3</span> = pos.<span class="title function_">clone</span>().<span class="title function_">subtract</span>(uiTouchPos.<span class="title function_">multiplyScalar</span>(scale));</span><br><span class="line">            <span class="comment">//UI setScale z 必须为非0</span></span><br><span class="line">            target.<span class="title function_">setScale</span>(<span class="title function_">v3</span>(scale, scale, <span class="number">1</span>));</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">dealScalePos</span>(<span class="title function_">v3</span>(mapPos.<span class="property">x</span>, mapPos.<span class="property">y</span>), target);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;smile----:&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&quot;特殊情况&quot;</span>));</span><br><span class="line">            scale = misc.<span class="title function_">clampf</span>(scale, <span class="variable language_">this</span>.<span class="property">minScale</span>, <span class="variable language_">this</span>.<span class="property">maxScale</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// render ui</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isValid</span>(<span class="variable language_">this</span>.<span class="property">scaleTime</span>))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">scaleTime</span>.<span class="property">string</span> = <span class="string">`<span class="subst">$&#123;<span class="built_in">Math</span>.floor(scale * <span class="number">100</span>)&#125;</span>%`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">dealScalePos</span>(<span class="attr">pos</span>: <span class="title class_">Vec3</span>, <span class="attr">target</span>: <span class="title class_">Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToWorldSpaceAR</span>(pos);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(target, <span class="variable language_">this</span>.<span class="property">node</span>, nodePos);</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">left</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">x</span> -= edge.<span class="property">left</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">right</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">x</span> += edge.<span class="property">right</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">top</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">y</span> += edge.<span class="property">top</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">bottom</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">y</span> -= edge.<span class="property">bottom</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target.<span class="title function_">setPosition</span>(<span class="title function_">v3</span>(pos.<span class="property">x</span>, pos.<span class="property">y</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">dealMove</span>(<span class="attr">dir</span>: <span class="title class_">Vec3</span>, <span class="attr">map</span>: <span class="title class_">Node</span>, <span class="attr">container</span>: <span class="title class_">Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;map.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="title class_">Vec3</span>.<span class="property">ZERO</span>));</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;container.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">        nodePos.<span class="title function_">add</span>(dir);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(map, container, nodePos);</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">left</span> &lt;= <span class="number">0</span> &amp;&amp; edge.<span class="property">right</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            map.<span class="title function_">setPosition</span>(map.<span class="property">position</span>.<span class="property">x</span> + dir.<span class="property">x</span>, map.<span class="property">position</span>.<span class="property">y</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">top</span> &lt;= <span class="number">0</span> &amp;&amp; edge.<span class="property">bottom</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            map.<span class="title function_">setPosition</span>(map.<span class="property">position</span>.<span class="property">x</span>, map.<span class="property">position</span>.<span class="property">y</span> + dir.<span class="property">y</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">dealSelect</span>(<span class="attr">nodePos</span>: <span class="title class_">Vec3</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`click map on (<span class="subst">$&#123;nodePos.x&#125;</span>, <span class="subst">$&#123;nodePos.y&#125;</span>)`</span>);</span><br><span class="line">        <span class="comment">// do sth</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">singleTouchCb</span>) <span class="variable language_">this</span>.<span class="title function_">singleTouchCb</span>(nodePos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算map的四条边距离容器的距离，为负代表超出去</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">calculateEdge</span>(<span class="attr">target</span>: <span class="title class_">Node</span>, <span class="attr">container</span>: <span class="title class_">Node</span>, <span class="attr">nodePos</span>: <span class="title class_">Vec3</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="comment">// distance to the edge when anchor is (0.5, 0.5)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">containerTransform</span>: <span class="title class_">UITransform</span> = &lt;<span class="title class_">UITransform</span>&gt;container.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">targetTransform</span>: <span class="title class_">UITransform</span> = &lt;<span class="title class_">UITransform</span>&gt;target.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">        <span class="keyword">let</span> targetScale = target.<span class="property">scale</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">horizontalDistance</span>: <span class="built_in">number</span> = (containerTransform.<span class="property">width</span> - targetTransform.<span class="property">width</span> * targetScale.<span class="property">x</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">verticalDistance</span>: <span class="built_in">number</span> = (containerTransform.<span class="property">height</span> - targetTransform.<span class="property">height</span> * targetScale.<span class="property">y</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">left</span>: <span class="built_in">number</span> = horizontalDistance + nodePos.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">right</span>: <span class="built_in">number</span> = horizontalDistance - nodePos.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">top</span>: <span class="built_in">number</span> = verticalDistance - nodePos.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">bottom</span>: <span class="built_in">number</span> = verticalDistance + nodePos.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;left, right, top, bottom&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@brief</span> 设置是否严格模式，如果为严格模式，则会过滤不在目标身上的触摸点， 反之不作处理</span></span><br><span class="line"><span class="comment">     *              默认为非严格模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">isStrict</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">setStrictPattern</span>(<span class="attr">isStrict</span>: <span class="built_in">boolean</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isStrict</span> = isStrict;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">getStrictPattern</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">isStrict</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>： <code>target.setScale(v3(scale, scale, 1));</code> 重点说明一下 设置UI界面 <code>scale</code> 属性的时候 这个 <code>Vec3</code> 类型的 <code>z</code> 一定要为非<code>0</code> 的值 否则会影响其他的 <code>touch</code>事件传递</p>
<h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><ol>
<li>新建一个场景 名字这里为 <code>main.scene</code></li>
<li>新建<code>Node</code>节点 名字为 <code>RootMapNode</code> 挂载一个系统组件 <code>Widget</code> left、 right、 top、 bottom 均为 0</li>
<li><code>RootMapNode</code>节点下面新建一个 <code>Node</code> 节点 为 <code>MapNode</code> </li>
<li><code>RootMapNode</code> 同级 新建一个 Label 节点</li>
<li>以上所有UI和节点 layer 选择 UI_2D</li>
<li>把 脚本 <code>MapTouchController.ts</code>组件 挂载到 <code>RootMapNode</code> 上面</li>
<li>把 <code>MapNode</code> 节点 指向 脚本的属性 <code>map</code></li>
<li>把 新建的<code>Label</code> 节点 指向脚本的属性 <code>scaleTime</code></li>
<li>运行游戏 查看效果</li>
</ol>
<h3 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h3><p>转换坐标的关键核心点：</p>
<ol>
<li>Vec2 和 Vec3 转换</li>
<li>getUILocation() 和 getLocation() 的区别</li>
</ol>
<p>注意：本脚本参考来自于  <a target="_blank" rel="noopener" href="https://blog.csdn.net/faker_in_c/article/details/103500238">Cocos Creator组件化开发之——地图类缩放拖动点击组件</a> 作者是用 Cocos Creator2.x 实现（<a target="_blank" rel="noopener" href="https://github.com/fakerincocos/MapControl-master">查看</a>）</p>
<p>我这里改成了3.6.2 另外 缩放的核心算法 有细微改动。</p>
<p>最后 源码地址：<a target="_blank" rel="noopener" href="https://github.com/jsroads/mylibs/tree/main/mapScaleDemo">点击查看</a></p>
<h2 id="惯性缓动优化版本2022-11-27更新"><a href="#惯性缓动优化版本2022-11-27更新" class="headerlink" title="惯性缓动优化版本2022-11-27更新"></a>惯性缓动优化版本2022-11-27更新</h2><h3 id="效果："><a href="#效果：" class="headerlink" title="效果："></a>效果：</h3><p><img src="/post/ce78284b/002.gif" alt="002"></p>
<h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h3><p>上面的版本已经完整的可以拖拽，但如果拖拽结束后如何惯性再运动一段距离呢？此时我们需要求出速度V 和摩擦力阻尼系数，然后做匀减速运动即可，此时我们先设置几个变量如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">NUMBER_OF_GATHERED_TOUCHES_FOR_MOVE_SPEED</span> = <span class="number">5</span>;<span class="comment">//统计最大移动次数个数</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="attr">brake</span>: <span class="built_in">number</span> = <span class="number">0.5</span>; <span class="comment">//惯性系数</span></span><br><span class="line"> <span class="keyword">public</span> <span class="attr">friction</span>: <span class="built_in">number</span> = <span class="number">0.85</span>; <span class="comment">//阻尼系数，摩擦力</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="attr">touchMoveDisplacements</span>: <span class="title class_">Vec3</span>[] = [];<span class="comment">//统计位置数组</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="attr">touchMoveTimeDeltas</span>: <span class="built_in">number</span>[] = [];<span class="comment">//统计时间数组</span></span><br><span class="line"> <span class="keyword">protected</span> touchMovePreviousTimestamp = <span class="number">0</span>;<span class="comment">//前一次事件时间戳</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="attr">autoScrolling</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;<span class="comment">//是否在惯性移动中</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="attr">speed</span>: <span class="title class_">Vec3</span> = <span class="keyword">new</span> <span class="title class_">Vec3</span>();<span class="comment">//当前速度</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="attr">targetPos</span>: <span class="title class_">Vec3</span> = <span class="keyword">new</span> <span class="title class_">Vec3</span>();<span class="comment">//目标移动位置</span></span><br></pre></td></tr></table></figure>

<p>然后在 点击触摸开始时候TOUCH_START或者触摸取消TOUCH_CANCEL开始重置统计 ：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">handleReleaseLogic</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">inertia</span>) <span class="keyword">return</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">touchMovePreviousTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">autoScrolling</span> = <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>移动的时候开始记录数据：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">dealMove</span>(<span class="attr">dir</span>: <span class="title class_">Vec3</span>, <span class="attr">map</span>: <span class="title class_">Node</span>, <span class="attr">container</span>: <span class="title class_">Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> clampDt = dir.<span class="title function_">clone</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;map.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="title class_">Vec3</span>.<span class="property">ZERO</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;container.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">    nodePos.<span class="title function_">add</span>(dir);</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(map, container, nodePos), <span class="attr">targetPos</span>: <span class="title class_">Vec3</span> = map.<span class="property">position</span>.<span class="title function_">clone</span>();</span><br><span class="line">    <span class="keyword">if</span> (edge.<span class="property">left</span> &lt;= <span class="number">0</span> &amp;&amp; edge.<span class="property">right</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        targetPos.<span class="property">x</span> += dir.<span class="property">x</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clampDt.<span class="property">x</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (edge.<span class="property">top</span> &lt;= <span class="number">0</span> &amp;&amp; edge.<span class="property">bottom</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        targetPos.<span class="property">y</span> += dir.<span class="property">y</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clampDt.<span class="property">y</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">gatherTouchMove</span>(clampDt);</span><br><span class="line">    <span class="comment">// this.targetPos = this.targetPos.lerp(this.targetPos,0.016 * 2.0);</span></span><br><span class="line">    map.<span class="title function_">setPosition</span>(targetPos.<span class="property">x</span>, targetPos.<span class="property">y</span>, targetPos.<span class="property">z</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">gatherTouchMove</span>(<span class="params">clampDt: Vec3</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="property">length</span> &gt;= <span class="variable constant_">NUMBER_OF_GATHERED_TOUCHES_FOR_MOVE_SPEED</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="title function_">shift</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="title function_">shift</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="title function_">push</span>(clampDt);</span><br><span class="line">    <span class="keyword">const</span> timeStamp = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="title function_">push</span>((timeStamp - <span class="variable language_">this</span>.<span class="property">touchMovePreviousTimestamp</span>) / <span class="number">1000</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">touchMovePreviousTimestamp</span> = timeStamp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>触摸结束的时候，开始统计结束时候的速度：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">processInertiaScroll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">inertia</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="variable language_">this</span>.<span class="title function_">calculateTouchMoveVelocity</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">x</span>) &gt; <span class="number">0</span> || <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">y</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">autoScrolling</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">calculateTouchMoveVelocity</span>(): <span class="title class_">Vec3</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> totalTime = <span class="number">0</span>;</span><br><span class="line">    totalTime = <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b, totalTime);</span><br><span class="line">    <span class="keyword">if</span> (totalTime &lt;= <span class="number">0</span> || totalTime &gt; <span class="number">0.75</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vec3</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> totalMovement = <span class="keyword">new</span> <span class="title class_">Vec3</span>();</span><br><span class="line">    totalMovement = <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">        a.<span class="title function_">add</span>(b);</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;, totalMovement);</span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">new</span> <span class="title class_">Vec3</span>(totalMovement.<span class="property">x</span> * (<span class="number">1</span> - <span class="variable language_">this</span>.<span class="property">brake</span>),</span><br><span class="line">        totalMovement.<span class="property">y</span> * (<span class="number">1</span> - <span class="variable language_">this</span>.<span class="property">brake</span>), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在 update 函数里 开始惯性运行：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">update</span>(<span class="params">dt: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">inertia</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">autoScrolling</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> speed = <span class="variable language_">this</span>.<span class="property">speed</span>.<span class="title function_">clone</span>();</span><br><span class="line">    speed.<span class="title function_">multiplyScalar</span>(<span class="variable language_">this</span>.<span class="property">friction</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="title class_">Vec3</span>.<span class="property">ZERO</span>)).<span class="title function_">clone</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToNodeSpaceAR</span>(worldPos).<span class="title function_">clone</span>();</span><br><span class="line">    nodePos.<span class="title function_">add</span>(speed);</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(<span class="variable language_">this</span>.<span class="property">map</span>, <span class="variable language_">this</span>.<span class="property">node</span>, nodePos), <span class="attr">targetPos</span>: <span class="title class_">Vec3</span> = <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">position</span>.<span class="title function_">clone</span>();</span><br><span class="line">    <span class="keyword">if</span> (edge.<span class="property">left</span> &gt; <span class="number">0</span> || edge.<span class="property">right</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        speed.<span class="property">x</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (edge.<span class="property">top</span> &gt; <span class="number">0</span> || edge.<span class="property">bottom</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        speed.<span class="property">y</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="title function_">v3</span>(<span class="title class_">Math</span>.<span class="title function_">round</span>(speed.<span class="property">x</span> * <span class="number">100</span>) / <span class="number">100</span>, <span class="title class_">Math</span>.<span class="title function_">round</span>(speed.<span class="property">y</span> * <span class="number">100</span>) / <span class="number">100</span>, speed.<span class="property">z</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">x</span>) &lt; <span class="number">0.1</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">y</span>) &lt; <span class="number">0.1</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">autoScrolling</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    targetPos.<span class="title function_">add</span>(<span class="variable language_">this</span>.<span class="property">speed</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">setPosition</span>(targetPos.<span class="property">x</span>, targetPos.<span class="property">y</span>, targetPos.<span class="property">z</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MapTouchBetterController.ts 完整代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    _decorator,</span><br><span class="line">    <span class="title class_">CCBoolean</span>,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    <span class="title class_">EventMouse</span>,</span><br><span class="line">    <span class="title class_">EventTouch</span>,</span><br><span class="line">    isValid,</span><br><span class="line">    <span class="title class_">Label</span>,</span><br><span class="line">    misc,</span><br><span class="line">    <span class="title class_">Node</span>,</span><br><span class="line">    <span class="title class_">Rect</span>,</span><br><span class="line">    rect,</span><br><span class="line">    <span class="title class_">Touch</span>,</span><br><span class="line">    <span class="title class_">UITransform</span>,</span><br><span class="line">    v2,</span><br><span class="line">    v3,</span><br><span class="line">    <span class="title class_">Vec2</span>,</span><br><span class="line">    <span class="title class_">Vec3</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;cc&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by jsroads on 2021/4/15.4:35 下午</span></span><br><span class="line"><span class="comment"> * Note:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> &#123;ccclass, property&#125; = _decorator;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NUMBER_OF_GATHERED_TOUCHES_FOR_MOVE_SPEED</span> = <span class="number">2</span>;<span class="comment">//统计最大移动次数个数</span></span><br><span class="line"><span class="meta">@ccclass</span>(<span class="string">&#x27;MapTouchBetterController&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MapTouchBetterController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Node</span>,</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;目标节点&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">map</span>: <span class="title class_">Node</span> = <span class="literal">null</span>!;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(<span class="title class_">Label</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">scaleTime</span>: <span class="title class_">Label</span> = <span class="literal">null</span>!;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;图片初始缩放&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">defaultScaling</span>: <span class="built_in">number</span> = <span class="number">1.1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;图片缩放最小scale&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">minScale</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;图片缩放最大scale&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">maxScale</span>: <span class="built_in">number</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;单点触摸容忍误差&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">moveOffset</span>: <span class="built_in">number</span> = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&#x27;滚轮缩放比率&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">increaseRate</span>: <span class="built_in">number</span> = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">displayName</span>: <span class="string">&#x27;双指缩放速率&#x27;</span>,</span><br><span class="line">        <span class="attr">max</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0.001</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">fingerIncreaseRate</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="attr">locked</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>; <span class="comment">// 操作锁</span></span><br><span class="line">    <span class="keyword">public</span> <span class="attr">singleTouchCb</span>: <span class="title class_">Function</span> = <span class="literal">null</span>!; <span class="comment">// 点击回调函数</span></span><br><span class="line">    <span class="meta">@property</span>(<span class="title class_">CCBoolean</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">isStrict</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>; <span class="comment">// 默认为非严格模式</span></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&quot;是否开启滚动惯性&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">inertia</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>; <span class="comment">// 是否开启滚动惯性</span></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&quot;惯性系数，范围 0~1, 1表示立刻停止 &quot;</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0.01</span>,</span><br><span class="line">        <span class="attr">max</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">step</span>: <span class="number">0.01</span>,</span><br><span class="line">        <span class="attr">range</span>: [<span class="number">0.01</span>, <span class="number">1</span>],</span><br><span class="line">        <span class="attr">slide</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">visible</span>: <span class="keyword">function</span> (<span class="params"><span class="variable language_">this</span>: MapTouchBetterController</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">inertia</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">brake</span>: <span class="built_in">number</span> = <span class="number">0.5</span>; <span class="comment">//惯性系数</span></span><br><span class="line">    <span class="meta">@property</span>(&#123;</span><br><span class="line">        <span class="attr">tooltip</span>: <span class="string">&quot;阻尼系数，摩擦力 范围大于 0 &quot;</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0.01</span>,</span><br><span class="line">        <span class="attr">max</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">step</span>: <span class="number">0.01</span>,</span><br><span class="line">        <span class="attr">visible</span>: <span class="keyword">function</span> (<span class="params"><span class="variable language_">this</span>: MapTouchBetterController</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">inertia</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="attr">friction</span>: <span class="built_in">number</span> = <span class="number">0.85</span>; <span class="comment">//阻尼系数，摩擦力</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">touchMoveDisplacements</span>: <span class="title class_">Vec3</span>[] = [];<span class="comment">//统计位置数组</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">touchMoveTimeDeltas</span>: <span class="built_in">number</span>[] = [];<span class="comment">//统计时间数组</span></span><br><span class="line">    <span class="keyword">protected</span> touchMovePreviousTimestamp = <span class="number">0</span>;<span class="comment">//前一次事件时间戳</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">autoScrolling</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;<span class="comment">//是否在惯性移动中</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">speed</span>: <span class="title class_">Vec3</span> = <span class="keyword">new</span> <span class="title class_">Vec3</span>();<span class="comment">//当前速度</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="attr">targetPos</span>: <span class="title class_">Vec3</span> = <span class="keyword">new</span> <span class="title class_">Vec3</span>();<span class="comment">//目标移动位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">isMoving</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>; <span class="comment">// 是否拖动地图flag</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">mapTouchList</span>: <span class="built_in">any</span>[] = []; <span class="comment">// 触摸点列表容器</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">removeTouchFromContent</span>(<span class="attr">event</span>: <span class="title class_">EventTouch</span>, <span class="attr">content</span>: <span class="built_in">any</span>[]): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">eventToucheIDs</span>: <span class="built_in">number</span>[] = event[<span class="string">&#x27;getTouches&#x27;</span>]().<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> v.<span class="title function_">getID</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> len = content.<span class="property">length</span>, i = len - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (eventToucheIDs.<span class="title function_">indexOf</span>(content[i].<span class="property">id</span>) &gt; -<span class="number">1</span>)</span><br><span class="line">                content.<span class="title function_">splice</span>(i, <span class="number">1</span>); <span class="comment">// 删除触摸</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算map的四条边距离容器的距离，为负代表超出去</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">calculateEdge</span>(<span class="attr">target</span>: <span class="title class_">Node</span>, <span class="attr">container</span>: <span class="title class_">Node</span>, <span class="attr">nodePos</span>: <span class="title class_">Vec3</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="comment">// distance to the edge when anchor is (0.5, 0.5)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">containerTransform</span>: <span class="title class_">UITransform</span> = &lt;<span class="title class_">UITransform</span>&gt;container.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">targetTransform</span>: <span class="title class_">UITransform</span> = &lt;<span class="title class_">UITransform</span>&gt;target.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">targetScale</span>: <span class="title class_">Vec3</span> = target.<span class="property">scale</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">horizontalDistance</span>: <span class="built_in">number</span> = (containerTransform.<span class="property">width</span> - targetTransform.<span class="property">width</span> * targetScale.<span class="property">x</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">verticalDistance</span>: <span class="built_in">number</span> = (containerTransform.<span class="property">height</span> - targetTransform.<span class="property">height</span> * targetScale.<span class="property">y</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">left</span>: <span class="built_in">number</span> = horizontalDistance + nodePos.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">right</span>: <span class="built_in">number</span> = horizontalDistance - nodePos.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">top</span>: <span class="built_in">number</span> = verticalDistance - nodePos.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">bottom</span>: <span class="built_in">number</span> = verticalDistance + nodePos.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;left, right, top, bottom&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@brief</span> 设置是否严格模式，如果为严格模式，则会过滤不在目标身上的触摸点， 反之不作处理</span></span><br><span class="line"><span class="comment">     *              默认为非严格模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">isStrict</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">setStrictPattern</span>(<span class="attr">isStrict</span>: <span class="built_in">boolean</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isStrict</span> = isStrict;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">getStrictPattern</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">isStrict</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">onLoad</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addEvent</span>();</span><br><span class="line">        <span class="comment">// this.defaultScaling = 1</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">smoothOperate</span>(<span class="variable language_">this</span>.<span class="property">map</span>, <span class="title function_">v3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">defaultScaling</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">setPosition</span>(<span class="number">0</span>, <span class="number">225</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">handleReleaseLogic</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">inertia</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMovePreviousTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">autoScrolling</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">gatherTouchMove</span>(<span class="params">clampDt: Vec3</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="property">length</span> &gt;= <span class="variable constant_">NUMBER_OF_GATHERED_TOUCHES_FOR_MOVE_SPEED</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="title function_">shift</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="title function_">shift</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="title function_">push</span>(clampDt);</span><br><span class="line">        <span class="keyword">const</span> timeStamp = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="title function_">push</span>((timeStamp - <span class="variable language_">this</span>.<span class="property">touchMovePreviousTimestamp</span>) / <span class="number">1000</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">touchMovePreviousTimestamp</span> = timeStamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">processInertiaScroll</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">inertia</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="variable language_">this</span>.<span class="title function_">calculateTouchMoveVelocity</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">x</span>) &gt; <span class="number">0</span> || <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">y</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">autoScrolling</span> = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">calculateTouchMoveVelocity</span>(): <span class="title class_">Vec3</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> totalTime = <span class="number">0</span>;</span><br><span class="line">        totalTime = <span class="variable language_">this</span>.<span class="property">touchMoveTimeDeltas</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b, totalTime);</span><br><span class="line">        <span class="keyword">if</span> (totalTime &lt;= <span class="number">0</span> || totalTime &gt; <span class="number">0.75</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vec3</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> totalMovement = <span class="keyword">new</span> <span class="title class_">Vec3</span>();</span><br><span class="line">        totalMovement = <span class="variable language_">this</span>.<span class="property">touchMoveDisplacements</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">            a.<span class="title function_">add</span>(b);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;, totalMovement);</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">new</span> <span class="title class_">Vec3</span>(totalMovement.<span class="property">x</span> * (<span class="number">1</span> - <span class="variable language_">this</span>.<span class="property">brake</span>),</span><br><span class="line">            totalMovement.<span class="property">y</span> * (<span class="number">1</span> - <span class="variable language_">this</span>.<span class="property">brake</span>), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">update</span>(<span class="params">dt: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">inertia</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">autoScrolling</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">let</span> speed = <span class="variable language_">this</span>.<span class="property">speed</span>.<span class="title function_">clone</span>();</span><br><span class="line">        speed.<span class="title function_">multiplyScalar</span>(<span class="variable language_">this</span>.<span class="property">friction</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="title class_">Vec3</span>.<span class="property">ZERO</span>)).<span class="title function_">clone</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToNodeSpaceAR</span>(worldPos).<span class="title function_">clone</span>();</span><br><span class="line">        nodePos.<span class="title function_">add</span>(speed);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(<span class="variable language_">this</span>.<span class="property">map</span>, <span class="variable language_">this</span>.<span class="property">node</span>, nodePos), <span class="attr">targetPos</span>: <span class="title class_">Vec3</span> = <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">position</span>.<span class="title function_">clone</span>();</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">left</span> &gt; <span class="number">0</span> || edge.<span class="property">right</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            speed.<span class="property">x</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">top</span> &gt; <span class="number">0</span> || edge.<span class="property">bottom</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            speed.<span class="property">y</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="title function_">v3</span>(<span class="title class_">Math</span>.<span class="title function_">round</span>(speed.<span class="property">x</span> * <span class="number">100</span>) / <span class="number">100</span>, <span class="title class_">Math</span>.<span class="title function_">round</span>(speed.<span class="property">y</span> * <span class="number">100</span>) / <span class="number">100</span>, speed.<span class="property">z</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">x</span>) &lt; <span class="number">0.1</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">speed</span>.<span class="property">y</span>) &lt; <span class="number">0.1</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">autoScrolling</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        targetPos.<span class="title function_">add</span>(<span class="variable language_">this</span>.<span class="property">speed</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">setPosition</span>(targetPos.<span class="property">x</span>, targetPos.<span class="property">y</span>, targetPos.<span class="property">z</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">canStartMove</span>(<span class="attr">touch</span>: <span class="title class_">Touch</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">        <span class="comment">// 有些设备单点过于灵敏，单点操作会触发TOUCH_MOVE回调，在这里作误差值判断</span></span><br><span class="line">        <span class="keyword">return</span> touch.<span class="title function_">getDelta</span>().<span class="title function_">length</span>() &gt; <span class="variable language_">this</span>.<span class="property">moveOffset</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有些设备单点过于灵敏，单点操作会触发TOUCH_MOVE回调，在这里作误差值判断</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">moveDistance</span>(<span class="attr">touch</span>: <span class="title class_">Touch</span>): <span class="title class_">Vec3</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">v3</span>(touch.<span class="title function_">getDelta</span>().<span class="property">x</span>, touch.<span class="title function_">getDelta</span>().<span class="property">y</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">addEvent</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_MOVE</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">touches</span>: <span class="title class_">Touch</span>[] = event.<span class="title function_">getTouches</span>(); <span class="comment">// 获取所有触摸点</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isStrict</span>) &#123; <span class="comment">// 严格模式下过滤掉初始点击位置不在目标节点范围内的触摸点</span></span><br><span class="line">                touches</span><br><span class="line">                    .<span class="title function_">filter</span>(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">startPos</span>: <span class="title class_">Vec2</span> = <span class="title function_">v2</span>(v.<span class="title function_">getStartLocation</span>()); <span class="comment">// 触摸点最初的位置</span></span><br><span class="line">                        <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">worldRect</span>: <span class="title class_">Rect</span> = <span class="title function_">rect</span>(</span><br><span class="line">                            worldPos.<span class="property">x</span> - transform.<span class="property">width</span> / <span class="number">2</span>,</span><br><span class="line">                            worldPos.<span class="property">y</span> - transform.<span class="property">height</span> / <span class="number">2</span>,</span><br><span class="line">                            transform.<span class="property">width</span>,</span><br><span class="line">                            transform.<span class="property">height</span></span><br><span class="line">                        );</span><br><span class="line">                        <span class="keyword">return</span> worldRect.<span class="title function_">contains</span>(startPos);</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">forEach</span>(<span class="function"><span class="params">v</span> =&gt;</span> &#123; <span class="comment">// 将有效的触摸点放在容器里自行管理</span></span><br><span class="line">                        <span class="keyword">let</span> <span class="attr">intersection</span>: <span class="built_in">any</span>[] = <span class="variable language_">this</span>.<span class="property">mapTouchList</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">v1</span> =&gt;</span> v1.<span class="property">id</span> === v.<span class="title function_">getID</span>());</span><br><span class="line">                        <span class="keyword">if</span> (intersection.<span class="property">length</span> === <span class="number">0</span>)</span><br><span class="line">                            <span class="variable language_">this</span>.<span class="property">mapTouchList</span>[<span class="variable language_">this</span>.<span class="property">mapTouchList</span>.<span class="property">length</span>] = (&#123;<span class="attr">id</span>: v.<span class="title function_">getID</span>(), <span class="attr">touch</span>: v&#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                touches = <span class="variable language_">this</span>.<span class="property">mapTouchList</span>.<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> v.<span class="property">touch</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (touches.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;multi touch&#x27;);</span></span><br><span class="line">                <span class="comment">// multi touch</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touch1</span>: <span class="title class_">Touch</span> = touches[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touch2</span>: <span class="title class_">Touch</span> = touches[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">delta1</span>: <span class="title class_">Vec2</span> = <span class="title function_">v2</span>(touch1.<span class="title function_">getDelta</span>());</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">delta2</span>: <span class="title class_">Vec2</span> = <span class="title function_">v2</span>(touch2.<span class="title function_">getDelta</span>());</span><br><span class="line">                <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touchPoint1</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(<span class="title function_">v3</span>(touch1.<span class="title function_">getUILocation</span>().<span class="property">x</span>, touch1.<span class="title function_">getUILocation</span>().<span class="property">y</span>));</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">touchPoint2</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(<span class="title function_">v3</span>(touch2.<span class="title function_">getUILocation</span>().<span class="property">x</span>, touch2.<span class="title function_">getUILocation</span>().<span class="property">y</span>));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="attr">distance</span>: <span class="title class_">Vec3</span> = touchPoint1.<span class="title function_">subtract</span>(touchPoint2);</span><br><span class="line">                <span class="comment">// const rateV2: Vec2 = v2(this.fingerIncreaseRate, this.fingerIncreaseRate);</span></span><br><span class="line">                <span class="keyword">let</span> <span class="attr">delta</span>: <span class="title class_">Vec2</span> = delta1.<span class="title function_">subtract</span>(delta2).<span class="title function_">multiplyScalar</span>(<span class="variable language_">this</span>.<span class="property">fingerIncreaseRate</span>);</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">scale</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(distance.<span class="property">x</span>) &gt; <span class="title class_">Math</span>.<span class="title function_">abs</span>(distance.<span class="property">y</span>)) &#123;</span><br><span class="line">                    scale = (distance.<span class="property">x</span> + delta.<span class="property">x</span>) / distance.<span class="property">x</span> * <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getScale</span>().<span class="property">x</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    scale = (distance.<span class="property">y</span> + delta.<span class="property">y</span>) / distance.<span class="property">y</span> * <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getScale</span>().<span class="property">y</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">pos</span>: <span class="title class_">Vec3</span> = touchPoint2.<span class="title function_">add</span>(<span class="title function_">v3</span>(distance.<span class="property">x</span> / <span class="number">2</span>, distance.<span class="property">y</span> / <span class="number">2</span>));</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">smoothOperate</span>(<span class="variable language_">this</span>.<span class="property">map</span>, pos, scale);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (touches.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;single touch&#x27;);</span></span><br><span class="line">                <span class="comment">// single touch</span></span><br><span class="line">                <span class="keyword">const</span> <span class="attr">touch</span>: <span class="title class_">Touch</span> = touches[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isMoving</span> || <span class="variable language_">this</span>.<span class="title function_">canStartMove</span>(touch)) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">const</span> <span class="attr">distance</span>: <span class="title class_">Vec3</span> = <span class="variable language_">this</span>.<span class="title function_">moveDistance</span>(touch);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">dealMove</span>(distance, <span class="variable language_">this</span>.<span class="property">map</span>, <span class="variable language_">this</span>.<span class="property">node</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//const distance: Vec3 = this.moveDistance(touch);</span></span><br><span class="line">                    <span class="comment">// console.log(&quot;smile----this.isMoving:&quot; + JSON.stringify(this.isMoving));</span></span><br><span class="line">                    <span class="comment">// console.log(&quot;smile----distance:&quot; + JSON.stringify(distance));</span></span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不能移动&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;未知触摸类型&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_START</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleReleaseLogic</span>();</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_END</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">touches</span>: <span class="built_in">any</span>[] = <span class="variable language_">this</span>.<span class="property">isStrict</span> ? <span class="variable language_">this</span>.<span class="property">mapTouchList</span> : event.<span class="title function_">getTouches</span>();</span><br><span class="line">            <span class="keyword">if</span> (touches.<span class="property">length</span> &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isMoving</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = <span class="title function_">v3</span>(event.<span class="title function_">getLocation</span>().<span class="property">x</span>, event.<span class="title function_">getLocation</span>().<span class="property">y</span>);</span><br><span class="line">                    <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">                    <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">dealSelect</span>(nodePos);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">false</span>; <span class="comment">// 当容器中仅剩最后一个触摸点时将移动flag还原</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">processInertiaScroll</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isStrict</span>) <span class="variable language_">this</span>.<span class="title function_">removeTouchFromContent</span>(event, <span class="variable language_">this</span>.<span class="property">mapTouchList</span>);</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">TOUCH_CANCEL</span>, <span class="function">(<span class="params">event: EventTouch</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">touches</span>: <span class="built_in">any</span>[] = <span class="variable language_">this</span>.<span class="property">isStrict</span> ? <span class="variable language_">this</span>.<span class="property">mapTouchList</span> : event.<span class="title function_">getTouches</span>();</span><br><span class="line">            <span class="comment">// 当容器中仅剩最后一个触摸点时将移动flag还原</span></span><br><span class="line">            <span class="keyword">if</span> (touches.<span class="property">length</span> &lt;= <span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">isMoving</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleReleaseLogic</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isStrict</span>)</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">removeTouchFromContent</span>(event, <span class="variable language_">this</span>.<span class="property">mapTouchList</span>);</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">on</span>(<span class="title class_">Node</span>.<span class="property">EventType</span>.<span class="property">MOUSE_WHEEL</span>, <span class="function">(<span class="params">event: EventMouse</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locked</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">scrollDelta</span>: <span class="built_in">number</span> = event.<span class="title function_">getScrollY</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">scale</span>: <span class="built_in">number</span> = (<span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">getScale</span>().<span class="property">x</span> + (scrollDelta / <span class="variable language_">this</span>.<span class="property">increaseRate</span>));</span><br><span class="line">            <span class="comment">// scale = this.map.getScale().x+0.2</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">target</span>: <span class="title class_">Node</span> = <span class="variable language_">this</span>.<span class="property">map</span>;</span><br><span class="line">            <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">pos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(<span class="title function_">v3</span>(event.<span class="title function_">getUILocation</span>().<span class="property">x</span>, event.<span class="title function_">getUILocation</span>().<span class="property">y</span>));</span><br><span class="line">            <span class="comment">// pos = v3(50,50)</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">smoothOperate</span>(target, pos, scale);</span><br><span class="line">            event.<span class="property">propagationStopped</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">smoothOperate</span>(<span class="attr">target</span>: <span class="title class_">Node</span>, <span class="attr">pos</span>: <span class="title class_">Vec3</span>, <span class="attr">scale</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="comment">// 放大缩小</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">minScale</span> &lt;= scale &amp;&amp; scale &lt;= <span class="variable language_">this</span>.<span class="property">maxScale</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取速率的小数后几位，防止速率过小时取整直接舍弃掉了变化</span></span><br><span class="line">            scale = <span class="title class_">Number</span>(scale.<span class="title function_">toFixed</span>(<span class="number">2</span>));</span><br><span class="line">            <span class="comment">// let deltaScale: number = scale - target.getScale().x;</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">uiScaleVec3</span>: <span class="title class_">Vec3</span> = <span class="title function_">v3</span>(target.<span class="title function_">getScale</span>().<span class="property">x</span>, target.<span class="title function_">getScale</span>().<span class="property">y</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">uiTouchPos</span>: <span class="title class_">Vec3</span> = (pos.<span class="title function_">clone</span>().<span class="title function_">subtract</span>(target.<span class="property">position</span>.<span class="title function_">clone</span>())).<span class="title function_">divide</span>(uiScaleVec3);</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">mapPos</span>: <span class="title class_">Vec3</span> = pos.<span class="title function_">clone</span>().<span class="title function_">subtract</span>(uiTouchPos.<span class="title function_">multiplyScalar</span>(scale));</span><br><span class="line">            <span class="comment">//UI setScale z 必须为非0</span></span><br><span class="line">            target.<span class="title function_">setScale</span>(<span class="title function_">v3</span>(scale, scale, <span class="number">1</span>));</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">dealScalePos</span>(<span class="title function_">v3</span>(mapPos.<span class="property">x</span>, mapPos.<span class="property">y</span>), target);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            scale = misc.<span class="title function_">clampf</span>(scale, <span class="variable language_">this</span>.<span class="property">minScale</span>, <span class="variable language_">this</span>.<span class="property">maxScale</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// render ui</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isValid</span>(<span class="variable language_">this</span>.<span class="property">scaleTime</span>))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">scaleTime</span>.<span class="property">string</span> = <span class="string">`<span class="subst">$&#123;<span class="built_in">Math</span>.floor(scale * <span class="number">100</span>)&#125;</span>%`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">dealScalePos</span>(<span class="attr">pos</span>: <span class="title class_">Vec3</span>, <span class="attr">target</span>: <span class="title class_">Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> transform = &lt;<span class="title class_">UITransform</span>&gt;<span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToWorldSpaceAR</span>(pos);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = transform.<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(target, <span class="variable language_">this</span>.<span class="property">node</span>, nodePos);</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">left</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">x</span> -= edge.<span class="property">left</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">right</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">x</span> += edge.<span class="property">right</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">top</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">y</span> += edge.<span class="property">top</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">bottom</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pos.<span class="property">y</span> -= edge.<span class="property">bottom</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target.<span class="title function_">setPosition</span>(<span class="title function_">v3</span>(pos.<span class="property">x</span>, pos.<span class="property">y</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">dealMove</span>(<span class="attr">dir</span>: <span class="title class_">Vec3</span>, <span class="attr">map</span>: <span class="title class_">Node</span>, <span class="attr">container</span>: <span class="title class_">Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> clampDt = dir.<span class="title function_">clone</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">worldPos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;map.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToWorldSpaceAR</span>(<span class="title function_">v3</span>(<span class="title class_">Vec3</span>.<span class="property">ZERO</span>));</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">nodePos</span>: <span class="title class_">Vec3</span> = (&lt;<span class="title class_">UITransform</span>&gt;container.<span class="title function_">getComponent</span>(<span class="title class_">UITransform</span>)).<span class="title function_">convertToNodeSpaceAR</span>(worldPos);</span><br><span class="line">        nodePos.<span class="title function_">add</span>(dir);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">edge</span>: <span class="built_in">any</span> = <span class="variable language_">this</span>.<span class="title function_">calculateEdge</span>(map, container, nodePos), <span class="attr">targetPos</span>: <span class="title class_">Vec3</span> = map.<span class="property">position</span>.<span class="title function_">clone</span>();</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">left</span> &lt;= <span class="number">0</span> &amp;&amp; edge.<span class="property">right</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            targetPos.<span class="property">x</span> += dir.<span class="property">x</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clampDt.<span class="property">x</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (edge.<span class="property">top</span> &lt;= <span class="number">0</span> &amp;&amp; edge.<span class="property">bottom</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            targetPos.<span class="property">y</span> += dir.<span class="property">y</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clampDt.<span class="property">y</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">gatherTouchMove</span>(clampDt);</span><br><span class="line">        <span class="comment">// this.targetPos = this.targetPos.lerp(this.targetPos,0.016 * 2.0);</span></span><br><span class="line">        map.<span class="title function_">setPosition</span>(targetPos.<span class="property">x</span>, targetPos.<span class="property">y</span>, targetPos.<span class="property">z</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">dealSelect</span>(<span class="attr">nodePos</span>: <span class="title class_">Vec3</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(`click map on ($&#123;nodePos.x&#125;, $&#123;nodePos.y&#125;)`);</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">singleTouchCb</span>) <span class="variable language_">this</span>.<span class="title function_">singleTouchCb</span>(nodePos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后 源码地址：<a target="_blank" rel="noopener" href="https://github.com/jsroads/mylibs/tree/main/mapScaleDemo">点击查看</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/faker_in_c/article/details/103500238">Cocos Creator组件化开发之——地图类缩放拖动点击组件</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/T910107/article/details/41322565">Cocos2d-js中实现惯性滑动效果</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/cocos-creator/engine/blob/314ede133/cocos/ui/scroll-view.ts">cocos-creator-<strong>scroll-view.ts</strong></a> </li>
</ul>

  </div>
  <!--文末结束语-->
  
    <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="iconfont icon-heartbeat" style="font-size:24px;"></i> The End --- </div>
  
  <!--页脚广告-->
  
  <div class="mdui-divider"></div>
  
  <nav>
    
      <a rel="prev" class="post-nav-item mdui-float-left" href="/post/49b1096d.html">
        <i class="iconfont icon-angle-left"></i>
        <span>PureMVC如何在Cocos Creator 3.0使用</span>
      </a>
    
    
      <a rel="next" class="post-nav-item mdui-float-right" href="/post/a05e79f.html">
        <span>使用正则删除代码的注释</span>
        <i class="iconfont icon-angle-right"></i>
      </a>
    
  </nav>
</article>




  <div class="toc-button"  style="z-index: 100;">
    <button class="mdui-fab mdui-ripple mdui-color-teal" mdui-menu="{target: '#toc'}"><i class="iconfont icon-list"></i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item">
        <a href="/post/ce78284b.html" id="toc-header" class="mdui-ripple">文章目录</a>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E6%83%AF%E6%80%A7%E7%AE%80%E5%8D%95%E7%89%88%E6%9C%AC"><span class="toc-number">1.</span> <span class="toc-text">无惯性简单版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-number">1.1.</span> <span class="toc-text">效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83"><span class="toc-number">1.2.</span> <span class="toc-text">核心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E5%88%B0%E7%9A%84%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">用到的事件类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E5%88%B0%E7%9A%84API"><span class="toc-number">1.2.2.</span> <span class="toc-text">用到的API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.3.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.</span> <span class="toc-text">具体操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">注意点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%83%AF%E6%80%A7%E7%BC%93%E5%8A%A8%E4%BC%98%E5%8C%96%E7%89%88%E6%9C%AC2022-11-27%E6%9B%B4%E6%96%B0"><span class="toc-number">2.</span> <span class="toc-text">惯性缓动优化版本2022-11-27更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">效果：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">2.2.</span> <span class="toc-text">步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol>
      </li>
    </ul>
  </div>



  </main>
  <footer id="footer" class="mdui-text-center mdui-m-t-5 mdui-p-b-2 mdui-p-t-4 mdui-color-theme">
  <div class="mdui-container">
    <div class="mdui-row">
      
        <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank"></a>
      
      <span>
        &copy; 2018 - 2025 
        
          <span style="color:#d9333f" class="iconfont icon-heart"></span>
        
        asroads
      </span>
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span>Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span>Theme: <a href="https://github.com/kb1000fx/Meadow" rel="noopener" target="_blank">Meadow</a></span>
        </div>
      
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span id="busuanzi_container_site_uv" style="display: none;"> <span class="iconfont icon-user"></span>总访客量 <span id="busuanzi_value_site_uv"></span></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span id="busuanzi_container_site_pv" style="display: none;"> <span class="iconfont icon-eye"></span>总访问量 <span id="busuanzi_value_site_pv"></span></span>
        </div>
      
    </div>
 </div>
</footer>
  
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-teal" style="z-index:100;"><i class="iconfont icon-arrowup"></i></button>
  
  

    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>




    
<script src="/js/mdui.min.v1.0.0.js"></script>




<script src="/js/meadow.js"></script>

</body>
</html >